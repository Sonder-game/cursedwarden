Архитектурный фреймворк и техническая спецификация системы инвентарного планирования в стиле Backpack Battles
Разработка современной системы управления инвентарем для асинхронных автобатлеров требует глубокой интеграции пространственной логики, реактивных структур данных и высокопроизводительных алгоритмов проверки пересечений. В играх данного жанра инвентарь перестает быть простым хранилищем предметов и превращается в первичный интерфейс стратегического планирования, где эффективность игрока в бою напрямую зависит от его способности решить сложную топологическую задачу по оптимизации размещения объектов.1 Настоящий отчет представляет собой исчерпывающее техническое руководство по воссозданию механик сборки инвентаря, идентичных игре Backpack Battles, для последующей интеграции в проект Cursed Warden.
Фундаментальная пространственная модель и логика сетки
В основе системы лежит дискретная двухмерная координатная сетка, где каждая ячейка представляет собой атомарную единицу пространства. В отличие от традиционных систем инвентаря, использующих фиксированные слоты, данная архитектура опирается на концепцию "свободного размещения в пределах доступных областей", что требует реализации сложной системы управления состоянием ячеек.1
Структура данных и управление областями
Сетка инвентаря определяется как набор координат $(x, y) \in \mathbb{Z}^2$. Каждая ячейка может находиться в одном из трех состояний: заблокирована (отсутствует сумка), свободна или занята предметом. Начальная конфигурация персонажа обычно включает 12–14 плиток из общего пула в 63 возможных позиции.1 Расширение доступного пространства происходит за счет приобретения и размещения специализированных предметов-сумок, таких как Leather Bag, Fanny Pack или Stamina Sack.1
Для эффективного управления этим пространством целесообразно использовать хеш-карту или словарь Dictionary<Vector2i, CellData>, где ключом является вектор координат, а значением — объект данных ячейки. Это позволяет динамически изменять форму инвентаря, добавляя новые области при размещении сумок. Каждая сумка сама по себе является предметом, который при установке в инвентарь или хранилище (Storage) должен активировать соответствующие ячейки сетки.1


Тип сумки
	Количество ячеек
	Специальные эффекты
	Leather Bag
	2x2 (4 ячейки)
	Базовое расширение без бонусов.1
	Fanny Pack
	2x1 (2 ячейки)
	Повышение скорости активации предметов на 10%.1
	Potion Belt
	3x1 (3 ячейки)
	Вероятность сохранения зелья при использовании.1
	Stamina Sack
	1x1 (1 ячейка)
	Восполнение выносливости при активации предметов.1
	Геометрия предметов и трансформации
Каждый предмет в системе определяется его формой, которая представляет собой массив локальных координат относительно точки вращения (pivot). Например, предмет размером 2x1 занимает ячейки $\{(0,0), (1,0)\}$. Важнейшей особенностью является возможность вращения предметов на 90 градусов с помощью клавиш R или E, а также колесика мыши.5
Математически вращение формы предмета на 90 градусов по часовой стрелке описывается преобразованием каждой локальной координаты $(dx, dy)$ в $(dx', dy')$ по формуле:


$$\begin{pmatrix} dx' \\ dy' \end{pmatrix} = \begin{pmatrix} 0 & -1 \\ 1 & 0 \end{pmatrix} \begin{pmatrix} dx \\ dy \end{pmatrix} = \begin{pmatrix} -dy \\ dx \end{pmatrix}$$
После вращения необходимо выполнить пересчет глобальных координат всех занимаемых ячеек и провести валидацию размещения. Валидация считается успешной, если все целевые ячейки инвентаря разблокированы и не заняты другими предметами. Во время перетаскивания система должна обеспечивать визуальную обратную связь, окрашивая "призрак" предмета в зеленый цвет при допустимом размещении и в красный — при наличии пересечений или выходе за границы.3
Механика синергии: Звезды и Ромбы
Центральным элементом глубины геймплея является система взаимного влияния предметов, визуализируемая через слоты типа "Звезда" ($\star$) и "Ромб" ($\diamond$). Эта механика превращает инвентарь в сложный граф зависимостей, где положение одного предмета может радикально изменить параметры всех окружающих.1
Логика триггеров и активации
Каждый предмет может иметь в своих метаданных описание зон влияния. Звезда представляет собой активный слот-активатор, который ищет подходящие предметы в определенных относительных координатах. Ромб — это пассивный идентификатор, указывающий, что данный предмет может служить ингредиентом или катализатором для Звезды другого предмета.1
Процесс обработки синергий должен быть реактивным. При любом изменении состояния инвентаря (перемещение, вращение, удаление предмета) система инициирует процедуру "пересчета графа".9 Алгоритм обходит все активные предметы и проверяет их зоны влияния. Если координаты ячейки, занимаемой предметом с подходящим тегом (например, "Food" или "Weapon"), совпадают с координатами Звезды другого предмета, устанавливается связь.1


Эффект синергии
	Пример предмета
	Механизм действия
	Ускорение (Haste)
	Fanny Pack
	Сокращает время перезарядки (Cooldown) предметов в слотах.1
	Бонус к урону
	Whetstone
	Добавляет фиксированный урон оружию в соседних ячейках.10
	Генерация ресурсов
	Mana Orb
	Генерирует ману при срабатывании синергии с магическими предметами.11
	Шанс критического удара
	Lucky Clover
	Повышает точность и шанс крита через накопление стаков Luck.1
	Направленные синергии и зависимость от ориентации
Ряд предметов, таких как луки и стрелы, используют направленную логику. Эффект стрелы применяется только к предмету, на который она "указывает".13 При вращении предмета вектор его влияния должен трансформироваться соответствующим образом. Это создает дополнительный уровень сложности, заставляя игрока учитывать не только позицию $(x, y)$, но и угол поворота каждого элемента для максимизации боевого потенциала.8
Важно отметить, что большинство характеристик в этой системе являются аддитивными. Например, два источника снижения урона по 25% в сумме дают 50%.14 Однако эффекты увеличения шанса срабатывания часто являются мультипликативными. Если базовый шанс блока щита составляет 30%, а предмет Fortuna's Grace дает бонус 1.3x, итоговый шанс составит $30\% \times 1.3 = 39\%$.14
Система крафта через физическое сближение
Одной из наиболее узнаваемых черт Backpack Battles является отсутствие традиционного меню крафта. Создание новых предметов происходит непосредственно в инвентаре путем размещения необходимых ингредиентов в соседних ячейках.5
Обнаружение рецептов и визуальные индикаторы
Система постоянно сканирует инвентарь на предмет соответствия предопределенным шаблонам рецептов. При обнаружении потенциальной связи между предметами в магазине или инвентаре отрисовываются линии различных цветов 4:
* Синие линии: Указывают на возможность объединения выбранного предмета с другим доступным объектом.4
* Тонкие золотые линии: Сигнализируют о том, что часть ингредиентов уже находится рядом, но рецепт не полон (например, "Hero Sword 1/2").5
* Толстые золотые линии: Подтверждают, что все условия для крафта выполнены и объединение произойдет в следующем раунде.5
* Зеленые линии: Указывают на использование катализатора, который участвует в превращении, но не исчезает после него (например, Blood Amulet при создании Vampiric Potion).4
Жизненный цикл объединения предметов
Процесс слияния разделен на несколько этапов, чтобы предотвратить случайную потерю ценных ресурсов и дать игроку время на корректировку.15 Объединение никогда не происходит мгновенно в фазе магазина. Игрок должен завершить раунд боя, сохранив необходимую конфигурацию предметов. Только после окончания боя, при возвращении в магазин, ингредиенты удаляются, и на их месте появляется новый предмет.15
Игроки имеют возможность заблокировать объединение (Item Locking), щелкнув правой кнопкой мыши по предмету. Это критически важно в ситуациях, когда ингредиент нужен для другого, более сложного рецепта, который игрок планирует собрать позже.4


Результат крафта
	Необходимые ингредиенты
	Тип связи
	Hero Sword
	Wooden Sword + Whetstone
	Расходуемые.11
	Hero Longsword
	Hero Sword + 2x Whetstone
	Расходуемые.11
	Vampiric Armor
	Leather Armor + Blood Amulet
	Катализатор (Amulet сохраняется).5
	Pandamonium
	Pan + Corrupted Crystal
	Расходуемые.10
	Eggscalibur
	Pan + Heroic Potion
	Расходуемые.10
	Экономика магазина и масштабирование редкости
Фаза магазина является стратегическим хабом, где случайность (RNG) ограничивается правилами прогрессии. Система должна обеспечивать постепенное увеличение силы игрока через динамическое изменение вероятностей появления предметов.1
Динамические вероятности и прогрессия раундов
Магазин предлагает 5 предметов, редкость которых зависит от текущего номера раунда. В первых раундах доминируют обычные (Common) и редкие (Rare) предметы, в то время как легендарные (Legendary) и божественные (Godly) имеют нулевой шанс появления.4 К середине игры (8–10 раунд) вероятности смещаются в сторону эпических предметов, а к 14 раунду и далее шансы на высокоуровневый лут становятся максимальными.4
Особую категорию составляют уникальные предметы (Unique), которые начинают появляться с 4-го раунда с базовым шансом 2%. Важное правило: уникальные предметы предлагаются только при первом входе в магазин в начале раунда и не могут быть получены через обновление ассортимента (Reroll).1
Механики взаимодействия с ассортиментом
Для глубокой настройки билда игроку предоставляются инструменты манипуляции магазином:
1. Обновление (Reroll): Тяга за веревку обновляет список товаров. Стоимость составляет 1 золото за первые 4 попытки, после чего цена возрастает до 2 золотых.1
2. Резервирование (Lock): Игрок может заблокировать конкретный предмет в магазине. Заблокированные предметы не исчезают при обновлении и сохраняются до следующего раунда.1
3. Распродажи (Sales): Каждый предмет имеет 10% шанс появиться со скидкой 50% (округление вверх). Стоимость продажи любого предмета игроком также составляет 50% от номинала. Это позволяет покупать товары по акции и перепродавать их без потери золота.1
4. Карты лояльности (Customer Card): Предметы, которые при каждом обновлении гарантированно повышают редкость одного случайного слота в магазине.14 Опытные игроки могут блокировать 4 ненужных слота, чтобы направить эффект улучшения на конкретный пятый предмет.14
Боевая система и трансформация данных инвентаря
После завершения фазы сборки состояние инвентаря фиксируется ("делается снимок") и передается в боевой движок. В этой фазе пространственные координаты перестают играть роль, а связи синергии преобразуются в итоговые модификаторы характеристик.2
Расчет характеристик и состояний
Бой происходит автоматически (Auto-battler). Предметы активируются циклически на основе их параметров перезарядки (Cooldown). На итоговую скорость активации влияют такие состояния, как Heat (ускорение) или Cold (замедление).1


Характеристика
	Описание
	Взаимодействие
	Accuracy
	Шанс попадания по цели.
	Снижается эффектом Blind, повышается стаками Luck.1
	Stamina
	Ресурс для атаки оружием.
	При нехватке выносливости скорость атак резко падает.1
	Block
	Поглощение входящего урона.
	Некоторые виды урона (яд, магия) могут игнорировать броню.1
	Spikes
	Отражение урона атакующему.
	Наносит 1 ед. урона за стак при получении удара в ближнем бою.1
	Vampirism
	Исцеление при атаке.
	Восстанавливает здоровье пропорционально нанесенному урону.1
	Бой продолжается до тех пор, пока у одного из игроков не закончатся очки здоровья. Если битва затягивается, наступает фаза усталости (Fatigue), в которой оба участника начинают получать прогрессирующий урон каждые 2 секунды, что гарантирует завершение поединка.1
Асинхронный мультиплеер и хранение данных
Система не требует нахождения обоих игроков в сети одновременно. После того как игрок собрал инвентарь и нажал кнопку начала боя, его билд сохраняется на сервере. В качестве оппонента система подбирает "снимок" (snapshot) другого игрока, который находился на том же раунде и имел схожий рейтинг.2 Это позволяет реализовать PvP-опыт без задержек и ожиданий, характерных для синхронных игр.5
Техническое руководство по реализации (Prompts для ИИ)
Для генерации кода системы в рамках проекта Cursed Warden (предположительно на Godot или Unity) рекомендуется использовать следующие структурированные инструкции.
Инструкция 1: Пространственный менеджер ячеек
"Разработай класс InventoryGrid, управляющий двухмерным пространством. Система должна использовать Dictionary<Vector2i, Cell> для хранения данных о ячейках. Реализуй функцию can_place_item(item_data, position, rotation), которая проверяет: 1. Наличие разблокированных ячеек под всей формой предмета. 2. Отсутствие перекрытий с другими предметами. Форма предмета задается массивом локальных координат. Добавь поддержку вращения через матричное преобразование координат формы."
Инструкция 2: Реактивный движок синергий
"Создай систему SynergyEngine, которая анализирует связи между предметами на основе слотов 'Звезда' и 'Ромб'. Предметы должны иметь список SynergySlot, содержащий относительную координату, тип цели (тег) и применяемый модификатор. При изменении инвентаря движок должен обходить все предметы, проверять пересечение их звезд с ромбами соседей и обновлять кэшированные боевые характеристики. Используй паттерн 'Observer' или сигналы для минимизации лишних вычислений."
Инструкция 3: Логика магазина и прогрессии
"Реализуй контроллер ShopManager, который генерирует ассортимент из 5 предметов на основе таблицы весов редкости, привязанной к номеру раунда. Включи механизмы: 1. Reroll с инкрементальной ценой. 2. Lock предмета, предотвращающий его замену. 3. Sale с 50% скидкой. Реализуй систему уникальных предметов, которые могут появиться только при генерации магазина в начале раунда с шансом 2% и блокируются при первом же реролле."
Инструкция 4: Визуализация связей и крафта
"Напиши систему отрисовки связей LinkRenderer, использующую Line2D или аналоги. Система должна динамически рисовать линии между предметами: синие для потенциальных рецептов, золотые для готовых к слиянию пар и зеленые для связей с катализаторами. Линии должны обновляться в реальном времени при перетаскивании предметов. Добавь шейдер свечения для предметов, находящихся под действием глобальных эффектов (аур)."
Инструкция 5: Боевой транслятор
"Разработай модуль BattleBridge, который конвертирует пространственную конфигурацию инвентаря в плоский список боевых сущностей. Каждая сущность должна содержать итоговые значения Cooldown, Damage, Accuracy и StaminaCost, рассчитанные с учетом всех активных синергий и бонусов от сумок. Этот модуль должен подготавливать данные для сериализации и отправки на сервер в качестве снимка игрока."
Расширенные рекомендации по оптимизации и UX
Для достижения уровня качества, соответствующего Backpack Battles, необходимо уделить внимание деталям взаимодействия и производительности.
1. Кэширование характеристик: Расчет всех синергий на каждом кадре может быть ресурсозатратным. Рекомендуется помечать инвентарь как "грязный" (dirty) при перемещении предметов и выполнять полный пересчет только перед началом боя или при открытии тултипа предмета.9
2. Интерфейс и подсказки: При наведении на предмет (или при зажатии Alt) система должна подсвечивать все связанные с ним объекты и выводить подробный список бонусов, которые он получает или отдает.4
3. Обработка звука и анимации: Вращение, покупка и особенно процесс слияния предметов должны сопровождаться сочными звуковыми эффектами и визуальными частицами. Это создает ощущение "физичности" инвентаря.2
4. Сглаживание сетки: При перетаскивании предмет не должен жестко привязываться к курсору. Использование интерполяции (Lerp) для движения "призрака" предмета к ближайшей валидной позиции сделает управление более приятным.3
Данная спецификация охватывает все ключевые аспекты механики Backpack Battles и предоставляет исчерпывающую базу для разработки аналогичной системы в Cursed Warden. Реализация предложенных алгоритмов обеспечит высокую степень вовлеченности игроков за счет глубокой стратегической составляющей и интуитивно понятного, но сложного в освоении процесса сборки инвентаря.
Источники
1. Game Mechanics - The Backpack Battles Wiki, дата последнего обращения: января 4, 2026, https://backpackbattles.wiki.gg/wiki/Game_Mechanics
2. Backpack Battles perfectly merges competition and relaxtion | by Russell Walters - Medium, дата последнего обращения: января 4, 2026, https://medium.com/@xtreme2g/backpack-battles-merges-competition-with-relaxtion-perfectly-eeafa8bea7d1
3. Complex inventory system : r/Unity3D - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/Unity3D/comments/13fkspm/complex_inventory_system/
4. Communauté Steam :: Guide :: Game Basics, Clarifications, дата последнего обращения: января 4, 2026, https://steamcommunity.com/sharedfiles/filedetails/?l=french&id=3187896204
5. Guide :: Game Basics, Clarifications - Steam Community, дата последнего обращения: января 4, 2026, https://steamcommunity.com/sharedfiles/filedetails/?id=3187896204
6. Rotating Items :: Backpack Battles General Discussions - Steam Community, дата последнего обращения: января 4, 2026, https://steamcommunity.com/app/2427700/discussions/0/3883851232923662841/
7. GridPack - Create Grid/Tetris Style Inventories - Developer Forum | Roblox, дата последнего обращения: января 4, 2026, https://devforum.roblox.com/t/gridpack-create-gridtetris-style-inventories/2891897
8. The game feels more and more Auto-pilot :: Backpack Battles Feedback - Steam Community, дата последнего обращения: января 4, 2026, https://steamcommunity.com/app/2427700/discussions/4/604148672905630532/
9. Optimizing our battle system : r/godot - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/godot/comments/1o1kh6m/optimizing_our_battle_system/
10. Backpack Battles Recipes and Analysis - Hardcore Gamer, дата последнего обращения: января 4, 2026, https://hardcoregamer.com/backpack-battles-recipes-and-analysis/
11. Recipe - The Backpack Battles Wiki, дата последнего обращения: января 4, 2026, https://backpackbattles.wiki.gg/wiki/Recipe
12. Backpack Battles 101! Beginner & Intermediate Guide - YouTube, дата последнего обращения: января 4, 2026, https://www.youtube.com/watch?v=Wb6-dEN4p-U
13. PSA: Rotate your items with synergies! - BackpackHero - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/BackpackHero/comments/wu2q75/psa_rotate_your_items_with_synergies/
14. Backpack Battles Mechanics & Tricks Thread : r/BackpackBattles - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/BackpackBattles/comments/1mtyvy3/backpack_battles_mechanics_tricks_thread/
15. Backpack Battles Recipe List - IGN, дата последнего обращения: января 4, 2026, https://www.ign.com/wikis/backpack-battles/Backpack_Battles_Recipe_List
16. How to combine items? : r/BackpackBrawl - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/BackpackBrawl/comments/1f5ly35/how_to_combine_items/
17. plot backpack battles item chances - GitHub Gist, дата последнего обращения: января 4, 2026, https://gist.github.com/wchargin/77d40c6dc6682fbe45a46c63b98526c1
18. Mechanics Questions Regarding Customer Card, Shop, and Special Items : r/BackpackBattles - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/BackpackBattles/comments/1lwt2b2/mechanics_questions_regarding_customer_card_shop/
19. BackPack Brawl - Tips and tricks for beginners - YouTube, дата последнего обращения: января 4, 2026, https://www.youtube.com/watch?v=WJpdqYiA1PQ
20. Removing on-hit Runaans was one of the worst decisions the TFT dev team has ever made, or why the enborification of TFT items has made the game less fun : r/CompetitiveTFT - Reddit, дата последнего обращения: января 4, 2026, https://www.reddit.com/r/CompetitiveTFT/comments/184qtl7/removing_onhit_runaans_was_one_of_the_worst/